{% extends "layout.html" %}

{% block content %}

<!-- TODO: add directory icons besides directories, and file icons besides files in the tree! -->
<script>
    function enable_loader() {
        const loader = document.getElementsByClassName('lds-ring')[0];
        // const loader = loaders.children[0];
        loader.style.display = 'inline-block';
        console.log('loader enabled')
    }
    function disable_loader() {
        const loader = document.getElementsByClassName('lds-ring')[0];
        loader.style.display = 'none';
        console.log('loader disabled')
    }
    var most_recent_project = null;
    function new_project() {
        enable_loader();
        var name = ""
        while (name.trim() == "") {
            name = prompt("Please provide a Project Name");
        }
        fetch('/new_project', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "projname": name.trim(),
            })
        }).then(response => {
            return response.json();
        }).then(json_data => {
            if (json_data.result == "success") {
                update_tree(json_data.tree);
            }
            else {
                // Set the output window to the output of the build
                output_window = document.getElementById("output_window")
                output_window.style.border = "1px solid red";
                output_window.innerHTML = '';
                // Add both the message and the output
                if (json_data.message) {
                    output_window.innerHTML = "Output: <pre style=\"color: white\">" + json_data.message + "</pre>";
                }
                if (json_data.output) {
                    output_window.innerHTML += "<pre style=\"color: white\">" + json_data.output + "</pre>";
                }
                alert('Failed to create new project')
            }
            disable_loader();
        }
        )

    }

    function new_file() {
        enable_loader();
        if (!current_dir) {
            alert("Please select a parent folder for the new file");
        }
        if (current_dir) {
            var name = ""
            while (name.trim() == "") {
                name = prompt("Please provide a valid file name");
            }
            fetch('/new_file', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: name.trim(),
                    "current_dir": current_dir
                })
            })
                .then(response => {
                    return response.json()
                }).then(data => {
                    if (data.result !== 'success') {
                        alert(data.message);
                    }
                    else {
                        update_tree(data.tree);
                    }
                    disable_loader();
                });
        }
    }

    function delete_file() {
        if (!current_file) {
            alert("Please select a file to delete from the directory tree");
            return;
        }

        if (!confirm('Are you sure?')) {
            return;
        }
        enable_loader();
        fetch('/delete_file', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                filename: current_file
            })
        }).then(response => response.json()
        ).then(data => {
            if (data.result == 'success') {
                update_tree(data.tree);
                // filename_container 
                // Set the text editor to empty
                var editor = ace.edit("editor");
                editor.setValue("");
                // Set the filename to empty
                document.getElementById("filename_name").innerHTML = "";
                // set edited false
                editor.session.getUndoManager().markClean();
                // Set the current file to null
                current_file = null;
                disable_loader();
                editor.session.getUndoManager().markClean();
            }
            else {
                alert(data.message);
            }
            disable_loader();
        }).catch(error => {
            console.log(error);
            alert("An error occurred while deleting the file. Please check that the file you are trying to delete exists.", error)
            disable_loader();
        });
    };



    function delete_folder() {
        if (!current_dir) {
            alert("Please select a folder to delete from the directory tree");
            return;
        }
        if (!confirm('Are you sure?')) {
            return;
        }
        enable_loader();
        fetch('/delete_folder?' + new URLSearchParams({
            current_dir: current_dir
        }))
            .then(response => response.json()).then(json_data => {
                if (json_data.result == 'success') {
                    update_tree(json_data.tree);
                    // filename_container 
                    // Set the text editor to empty
                    var editor = ace.edit("editor");
                    editor.setValue("");
                    // Set the filename to empty
                    document.getElementById("filename_name").innerHTML = "";
                    // set edited false
                    editor.session.getUndoManager().markClean();
                    // Set the current file to null
                    current_file = null;

                    editor.session.getUndoManager().markClean();
                    current_dir = null;
                    selected_dir = null;
                }
                else {
                    alert("Error:", json_data.message);

                }
                disable_loader();

            }).catch(error => {
                console.log(error);
                alert("An error occurred while deleting the folder. Please check that the folder you are trying to delete exists.", error)
                disable_loader();
            });

    }


    function save_file() {
        if (!current_file) {
            return;
        }
        // if current file ends with ".toml", run the toml validator.
        if (current_file.endsWith(".toml")) {
            validateToml();
        }
        var editor = ace.edit("editor");
        document.getElementById("save_indicator").hidden = true;
        file_contents = editor.getValue()
        if (current_file) {
            fetch('/save_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "file_contents": file_contents,
                    "current_file": current_file
                })
            }).then(response => {
                if (response.ok) {
                    editor.session.getUndoManager().markClean();
                }
            });
        }
        else {
            alert("Please select a file to save from the directory tree");
        }
    }

    function generate_bin() {


        if (current_dir) {
            enable_loader();
            fetch('/generate_bin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    "directory": current_dir
                })
            })
                .then(function (response) {
                    return response.json();
                }).then(json_data => {
                    if (json_data.success) {
                        update_tree(json_data.tree);

                        output_window = document.getElementById("output_window")
                        output_window.style.border = "1px solid green";
                        output_window.innerHTML = '<pre style=\"color: white\">Successfully generated bin file </pre>';
                    } else {
                        // Set the output window to the output of the build
                        output_window = document.getElementById("output_window")
                        output_window.innerHTML = "\n<pre style=\"color: white; font-size: 20\">Make sure you build your project first, and assign correct pins in config.toml. See the bottom of the output below for more information</pre><hr />";
                        output_window.style.border = "1px solid red";

                        // Add both the message and the output
                        if (json_data.message) {
                            output_window.innerHTML += "Output: <pre style=\"color: white\">" + json_data.message + "</pre>";
                        }
                        if (json_data.output) {
                            output_window.innerHTML += "<pre style=\"color: white\">" + json_data.output + "</pre>";
                        }
                        disable_loader();
                    }

                }).catch(error => {
                    alert("Internal Server Error: " + error);
                    disable_loader();
                })
        }
        else {
            alert("Please select a folder to generate a binary from");
        }

    }

    function zip_folder() {
        if (current_dir) {
            fetch('/get_zipped_folder?' + new URLSearchParams({
                directory: current_dir
            }))
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const short_filename = current_dir.substring(current_dir.lastIndexOf('/') + 1);

                    console.log("short_filename: " + short_filename);
                    console.log("url: " + url);

                    const a = document.createElement('a');
                    a.href = url;

                    a.download = short_filename + ".zip";
                    document.body.appendChild(a); // we need to append the element to the dom -> otherwise it will not work in firefox
                    a.click();
                })
                .catch(error => console.error('Error downloading binary file:', error));
            // .then(function (response) {
            //     console.log(response)
            //     if (response.status != 200) {
            //         alert("Error downloading the project")
            //     }
            //     // get_and_update_tree();
            // })
        } else {
            alert("Please select a project to zip");
        }
    }

    function synthesize() {

        if (current_file) {
            enable_loader();
            // save the file and send the filename over to the backend
            save_file()
            fetch('/synthesize_file?' + new URLSearchParams({
                filename: current_file
            }))
                .then(function (response) { return response.json(); })
                .then(json => {
                    output_window = document.getElementById("output_window")

                    output_window.innerHTML = `Output: <pre style="color: white">` + json.output + "</pre>" // TODO: change this, and handle errors
                    // TODO: change color of border based on json response
                    output_window.style.border = "1px solid white";
                    disable_loader();
                }), error => {
                    console.log(error);
                    disable_loader();
                };
        } else {
            alert("Please select a file to synthesize from the directory tree");
        }

    }
    // This function depends on this code here:
    // https://github.com/jakwings/toml-j0.4
    function validateToml() {
        if (current_file) {
            // save the file and send the filename over to the backend
            const toml_data = editor.getValue()
            console.log(toml_data);

            try {
                var data = toml.parse(toml_data);
                const warnings = validate_specific_format_toml(data);
                if (!warnings) {
                    output_window.style.border = "1px solid green";
                    output_window.innerHTML = "Output: <pre style=\"color: green\">Config file syntax correct</pre>";
                } else {
                    output_window.style.border = "1px solid #808000";
                    output_window.innerHTML = "Output: <pre style=\"color: yellow\">" + warnings + "</pre>";
                }
            } catch (err) {
                if (err.line && err.column) {
                    var error_message = 'Line ' + err.line + ', column ' + err.column + ': ' + err;
                }
                else {
                    error_message = err;
                }
                output_window.innerHTML = `Output: <pre style="color: white">` + error_message + "</pre>"
                output_window.style.border = "1px solid red";

            }
            console.log("Done");

        } else {
            alert("Please select a valid config.toml file");
        }
    }
    // Makes sure the toml file provided by a student matches exactly
    // that which we depend our Makefile on.
    function validate_specific_format_toml(toml_data) {
        let warnings = "";
        // Validate the needed fields fields exist
        let { pins, project, toplevel, src } = toml_data;
        console.log(toml_data, toplevel);

        // Validate that the pins table exists, and each pin is unique
        if (!pins) {
            throw new Error("Missing [pins] table in config file");
        }
        const pin_set = new Set();
        for (const pin_mapping in pins) {
            if (!pin_set.has(pins[pin_mapping])) {
                pin_set.add(pins[pin_mapping]);
            } else {
                throw new Error(`The variable "${pin_mapping}" cannot be assigned to pin "${pins[pin_mapping]}" as the pin is already mapped to.\nPlease update your config.toml file.`);
            }
        }

        // Project 

        // Check that the variable is set (empty string is set)
        if (!project && typeof (project) != "string") {
            throw new Error(`The 'project' field is missing. Please add this variable to the "config.toml" file`);
        }
        if (typeof (project) != "string") {
            throw new Error('The "project" field must be a string. Please change the variable type in the "config.toml" file.');
        }
        if (project == "") {
            warnings += 'Warn: The "project" variable is an empty string in "config.toml"\n';
        }
        // Toplevel
        if (!toplevel && typeof (toplevel) != "string") {
            throw new Error(`The 'toplevel' field is missing. Please add this variable to the "config.toml" file`);
        }
        if (typeof (toplevel) != "string") {
            throw new Error('The "toplevel" field must be a string. Please change the variable type in the "config.toml" file.');
        }
        if (toplevel == "") {
            warnings += 'Warn: The "toplevel" variable is an empty string in "config.toml"\n';
        }
        // Source File List
        if (!src) {
            throw new Error(`The 'src' field is missing. Please add this variable to the "config.toml" file`);
        }
        if (!Array.isArray(src)) {
            throw new Error('The "src" field must be a list. Please change the variable type in the "config.toml" file.');
        }
        if (src.length == 0) {
            warnings += 'Warn: The "src" list is empty in "config.toml"\n';
        }
        return warnings;
    }
    function build() {
        if (!current_dir) {
            alert("Please select a project to build from the directory tree");
            return;
        }
        enable_loader();
        fetch('/build', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                "directory": current_dir
            })
        }).then(function (response) {
            return response.json();
        })
            .then(json_data => {
                if (json_data.result == "success") {
                    // Update the tree
                    update_tree(json_data.tree);
                    console.log(json_data.tree);
                    // Update the output window
                    output_window = document.getElementById("output_window")
                    output_window.style.border = "1px solid green";
                    output_window.innerHTML = "Output: <pre style=\"color: green\">" + json_data.output + "</pre>";
                } else {
                    output_window = document.getElementById("output_window")
                    output_window.style.border = "1px solid red";
                    // Add both the message and the output
                    output_window.innerHTML = "Output: <pre style=\"color: white\">" + json_data.message + "</pre>" + "<pre style=\"color: white\">" + json_data.output + "</pre>";
                }
                disable_loader();
            }).catch(error => {
                alert('Internal Server Error: ' + error);
                console.log(error);
                disable_loader();
            });

    }

    function analyze() {

        if (current_file) {
            enable_loader();
            // save the file and send the filename over to the backend
            save_file()

            fetch('/analyze_ghdl_file?' + new URLSearchParams({
                filename: current_file
            }))
                .then(function (response) { return response.json(); })
                .then(json => {
                    output_window = document.getElementById("output_window")
                    if (json.output.trim() != "" && !json.success) {
                        output_window.innerHTML = `Output: <pre style="color: white">` + json.output + "</pre>"
                        output_window.style.border = "1px solid red";
                    } else {
                        output_window.style.border = "1px solid green";
                        output_window.innerHTML = "Output: <pre style=\"color: green\">No errors!</pre>";
                    }
                    disable_loader();
                }), error => {
                    console.log(error);
                    disable_loader();
                };
        } else {
            alert("Please select a file to analyze from the directory tree");
        }

    }
</script>
<script>
    function ChangeDropDown() {
        var dropdown = document.getElementById("dropdownButtonTop");
        if (dropdown.style.display === "none") {
            dropdown.style.display = "block";
            document.getElementById("DropDown").innerHTML = "Show Less";
        } else {
            dropdown.style.display = "none";
            document.getElementById("DropDown").innerHTML = "Show More";
        }
    }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.12.3/ace.js"
    integrity="sha512-yARx+3W/tyZPXyRfZ4DLRdj0rXF2yjH2D6bKpPslrl1c62Q6ZC808L++ft9jkzIN9vmLtQCFsYNrzoOE/Im2Dg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<div id="background">

    <div class="title"> VHDL Web Editor </div>
    <div class="lds-ring">
        <div></div>
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div id="navbar-container">
        <div class="navbar-top" style="margin-left: 10">
            <button class="button-40" id="Analyze" onclick="analyze()">Analyze</button>
            <button class="button-40" role="button" onclick="synthesize()">Synthesize</button>
            <button class="button-33" id="DropDown" onclick="ChangeDropDown()">Show Less </button>
            <div id="dropdownButtonTop" style="margin-left: 10">
                <button class="button-40" id="New_Project" onclick="new_project()">New Project</button>
                <button class="button-40" id="New_File" onclick="new_file()">New File</button>
                <button class="button-40" id="Delete_Folder" onclick="delete_folder()">Delete Project</button>
                <button class="button-40" id="Delete_File" onclick="delete_file()">Delete File</button>
                <button class="button-40" id="Save_File" onclick="save_file()">Save</button>
                <button class="button-40" id="Download_Project" onclick="zip_folder()">Download Project</button>
                <button class="button-40" id="Analyze" onclick="analyze()">Analyze</button>
                <button class="button-40" role="button" onclick="synthesize()">Synthesize</button>
                <button class="button-40" id="Build" onclick="build()">Build</button>
                <button class="button-40" id="Generate_Bin" onclick="generate_bin()">Generate Bitstream</button>
            </div>

        </div>
    </div>
    <div class="bottom-box">
        <!-- the resizabel file tree  -->
        <div class="resize" id="filetree">

            <!-- Directory tree begins -->
            <!-- <ol id="myUL"> -->

            {%- for item in tree.children recursive %}
            <li class="file-tree-file">
                {%- if item.children is defined -%}
                &nbsp; <i class="fa fa-folder" style="color: white"></i>
                {%- elif item.name.endswith('.vhd') -%}
                <i class="fa fa-file-code-o" style="color: white"></i>
                {% elif item.name.endswith('.toml') -%}
                <i class="fa fa-file-text-o" style="color: white"></i>
                {%- else -%}
                <i class="fa fa-file-o" style="color: gray"></i>
                {%- endif %}
                <span class="caret" id="{{ item.path }}" data-pathname="{{ item.path }}"
                    data-dirname="{{ item.dirname }}">
                    {{ item.name }}
                </span>
                {%- if item.children is defined -%}
                <ul class="nested">
                    {{ loop(item.children) }}</ul>
                <br />
                <br />
                {%- endif %}
            </li>
            {%- endfor %}

            <!-- </ol> -->
            <!-- Directory tree ends -->
        </div>
        <div class="name-and-ide-box">

            <div class="filename" id="filename_container" style="display: none;"><img width="20px" height="20px"
                    style="margin-right: 5px;" src="https://www.eecs.tufts.edu/~ebrown26/ankur-img.png"
                    id="save_indicator" hidden /><span id="filename_name"></span></div>
            <!-- the text editor -->
            <div id="editor_container">
                <div class="ide" id="editor"> {{ file_contents }} </div>
                <div id="netlist-svg" class="netlist-svg"></div>
            </div>
            <script>
                var editor = ace.edit("editor");
                editor.setTheme("ace/theme/twilight");
                editor.session.setMode("ace/mode/vhdl");
                document.getElementById("editor").style.fontSize = '14px';
            </script>

        </div>
    </div>
    <!-- This is where the output messages would appear, if any.
        Such as "Line 25: unknown variable 'TODO'"-->
    <div class="output_window_class" id="output_window" style="overflow:auto; resize:vertical; min-height: 30px">

    </div>
</div>

<script>
    // Find if a document has been edited, indicate its changed
    // https://stackoverflow.com/questions/19670178/how-to-use-the-undomanager-to-determine-if-document-has-unsaved-changes
    var saveIndicator = document.getElementById("save_indicator");
    saveIndicator.hidden = true;
    var editor = ace.edit("editor");
    // using input event instead of change since it's called with some timeout
    editor.on("input", function () {
        saveIndicator.hidden = editor.session.getUndoManager().isClean();
        let src = '/images/edit-icon.png';
        saveIndicator.src = src;
    });
</script>

<body onbeforeunload="if (!document.getElementById('editor').session.getUndoManager().isClean()) {
    return 'save changes'; }
    else { return; }">


    <script>

        function downloadURI(uri, name) {
            var link = document.createElement("a");
            link.download = name;
            link.href = uri;
            document.body.appendChild(link);

        }

        // var toggler = document.getElementsByClassName("caret");


        // var i;
        // var current_file = null;
        // var current_dir = null; // string pathname
        // var selected_dir = null; // document object
        var i;
        var current_file = null;
        var current_dir = null; // string pathname
        var selected_dir = null; // document object
        function addTreeListeners() {

            var toggler = document.getElementsByClassName("caret");
            console.log("toggler length is: ", toggler.length);
            for (i = 0; i < toggler.length; i++) {
                toggler[i].addEventListener("click", function () {
                    nested = this.parentElement.querySelector(".nested");
                    console.log("nested is: ", nested);
                    if (nested == null) {
                        if (current_file != null && ace.edit("editor").session && !ace.edit("editor").session.getUndoManager().isClean()) {
                            const response = confirm("You have unsaved data, would you like to progress?");
                            if (!response) {
                                return;
                            }
                        }
                        editor = document.getElementById("editor");
                        pathname = this.getAttribute("data-pathname");
                        current_file = pathname;
                        console.log("pathname is: ", pathname);
                        filename_container_name = document.getElementById("filename_name");
                        // filename_container_name is null for some reason
                        if (current_file) { filename_container_name.innerHTML = current_file.substring(current_file.indexOf('.es4/') + 5); }
                        if (pathname != "" && pathname != null) {
                            // view the file name
                            filename_container = document.getElementById("filename_container");
                            filename_container.style.display = "block";

                            // get request to backend to receive data to render
                            if (current_file.endsWith(".bin")) {
                                const target = '/get_binary_file?' + new URLSearchParams({ filename: pathname });
                                fetch(target, { method: 'GET' })
                                    .then(response => response.blob())
                                    .then(blob => {
                                        const url = window.URL.createObjectURL(blob);
                                        const short_filename = pathname.substring(pathname.lastIndexOf('/') + 1);
                                        // Create a button that onClick downloads the url, and set the innerHTML of 
                                        //  document.getElementById("netlist-svg").style.display = "block"; 
                                        // this element will have it's inner HTML updated
                                        const button =
                                            `<a href=` + url + ` download="` + short_filename + `"  style="text-decoration:none">
                                            <div style="padding:20px;border-radius:15px;margin:20;font-size:26;background-color:gray;color:white;">
                                                Download ` + short_filename + `
                                            </div>
                                            
                                            </a>`;
                                        document.getElementById("netlist-svg").style.display = 'block';
                                        document.getElementById("netlist-svg").innerHTML = button;
                                        // hide the editor 
                                        document.getElementById("editor").style.display = "none";
                                        return;
                                    })
                                    .catch(error => console.error('Error downloading binary file:', error));
                                return;
                            }


                            target = '/get_file?' + new URLSearchParams({ filename: pathname })
                            fetch(target, {
                                method: 'GET'
                            })
                                .then(function (response) { return response.json(); })
                                .then(function (json) {
                                    // if pathname ends with svg, set the ace editor to svg mode.
                                    if (pathname.endsWith(".svg")) {
                                        // hide the editor
                                        document.getElementById("editor").style.display = "none";


                                        // show the svg
                                        document.getElementById("netlist-svg").style.display = "block";


                                        // console.log(document.getElementById("editor").innerHTML);
                                        // make the innerHTML scrollable on overflow 
                                        document.getElementById("netlist-svg").innerHTML = `<div style="overflow:auto; resize:vertical; min-height: 400px">` + json.contents + `</div>`;
                                        document.getElementById("netlist-svg").style.backgroundColor = "lightgray";
                                    } else {
                                        // replace inner html with ace editor and set mode to vhdl and fill with contents
                                        // Show the editor
                                        document.getElementById("editor").style.display = "block";

                                        // hide the svg
                                        document.getElementById("netlist-svg").style.display = "none";

                                        editor = ace.edit("editor");
                                        editor.session.setTabSize(4);

                                        if (pathname.endsWith(".txt")) {
                                            editor.session.setMode("ace/mode/text");
                                        }
                                        else if (pathname.endsWith(".toml")) {
                                            editor.session.setMode("ace/mode/toml");
                                        }
                                        else {
                                            editor.session.setMode("ace/mode/vhdl");
                                        }
                                        editor.setTheme("ace/theme/twilight");
                                        document.getElementById("editor").style.fontSize = '14px';

                                        editor.setValue(json.contents, -1);
                                        // console.log(json.contents);
                                    }
                                    editor.session.getUndoManager().markClean();
                                });
                        } else if (pathname == "") {
                            current_dir = this.getAttribute("data-dirname")
                            if (selected_dir != null) {
                                selected_dir.style.border = ""; // unselect the old color
                            }
                            selected_dir = this;
                        }

                    } else {
                        nested.classList.toggle("active");
                        this.classList.toggle("caret-down");
                        this.style.backgroundColor = "green";

                        current_dir = this.getAttribute("data-dirname");
                        // if (toggler.length <= 2) {this.style.border = "1px solid red" ;}

                        for (i = 0; i < toggler.length; i++) {
                            // Close the dropdowns of the others
                            if (toggler[i] != this) {
                                toggler[i].style.backgroundColor = "#2A2C48";
                                toggler[i].classList.remove("caret-down");
                                // if there is a parent element, remove the active class
                                if (toggler[i].parentElement?.querySelector(".nested") != null) {
                                    toggler[i].parentElement.querySelector(".nested").classList.remove("active");
                                    // set the background for that element to be white   
                                    toggler[i].parentElement.style.backgroundColor = "#2A2C48";
                                }

                            }

                        }
                        selected_dir = this;
                    }
                });
            }
        }
        addTreeListeners();
        // command S implementation: https://www.thatsoftwaredude.com/content/8783/how-to-ctrl--s-to-save-in-javascript
        var isCtrl = false;
        window.addEventListener('load', function () {
            document.getElementById('editor').addEventListener('keydown', function (e) {
                if (e.keyCode == 17 || e.keyCode == 91) { // cmd or ctrl
                    e.preventDefault();
                    isCtrl = true;
                }

                if (e.keyCode == 83 && isCtrl) {
                    e.preventDefault();
                    save_file();
                }
            });
        });

        document.getElementById('editor').addEventListener('keyup', function (e) {
            e.preventDefault();
            isCtrl = false;
        });

    </script>


    <script>
        // Define a function to recursively generate the HTML for the directory tree
        function generateTreeHTML(tree) {
            let html = '';
            for (const item of tree.children) {
                html += `<li class="file-tree-file">`;
                if (item.children) {
                    html += `&nbsp;&nbsp;<i class="fa fa-folder" style="color: white"> </i> `;
                    html += `<span class="caret" id="${item.path}" data-pathname="${item.path}" data-dirname="${item.dirname}">${item.name} </span>`;
                    html += `<ul class="nested">`
                    html += generateTreeHTML(item); // Recursively generate HTML for child nodes
                    html += `</ul><br /><br />`
                } else {
                    if (item.name.endsWith(".txt")) {
                        html += `<i class="fa fa-file-text-o" style="color: white"></i>`;
                    }
                    //  check for vhdl files 
                    else if (item.name.endsWith(".vhd")) {
                        html += `<i class="fa fa-file-code-o" style="color: white"></i>`;
                    }
                    else if (item.name.endsWith(".toml")) {
                        html += `<i class="fa fa-file-text-o" style="color: white"></i>`;
                    }
                    else {
                        html += `<i class="fa fa-file-o" style="color: gray"></i>`;
                    }
                    html += `<span class="caret" id="${item.path}" data-pathname="${item.path}" data-dirname="${item.dirname}" oncontextmenu="window.alert('todo'); return false;"> ${item.name} </span>`;
                }
                html += `</li>`;
            }

            return html;
        }
        function update_tree(data) {
            // Get a list of already toggled directories
            let toggled = [];
            // Find nested active
            let active = document.getElementsByClassName("nested active");
            let previous_activated_dir = null
            // There is only expected to be one active directory.
            // Loop through any ways
            for (let i = 0; i < active.length; i++) {
                let parent = active[i].parentElement;
                if (parent == null) {
                    continue;
                }
                let span = parent.getElementsByTagName("span")[0];
                previous_activated_dir = span.getAttribute("data-dirname");
            }
            let treeHTML = "";
            treeHTML += generateTreeHTML(data);
            document.getElementById('filetree').innerHTML = treeHTML;


            addTreeListeners();
            // Activate the previously toggled directories
            // Find the element with the data-dirname attribute matching the previous_activated_dir
            if (previous_activated_dir) {
                let toggled_dir = document.querySelector(`[data-dirname="${previous_activated_dir}"]`);
                if (toggled_dir == null) {
                    return;
                }
                let parent = toggled_dir.parentElement;
                toggled_dir.click();
            }
        }
        function get_and_update_tree() {
            // Fetch the directory tree data from the server and render it
            fetch('/get_tree')  // Replace '/tree' with the URL of the server endpoint that returns the tree data
                .then(response => response.json())
                .then(tree => {
                    update_tree(tree);
                })
                .catch(error => {
                    console.error(error);
                    // Handle error
                });
        }

    </script>
    <!-- Script that allows us to validate TOML on button press -->
    <script src="{{url_for('static', filename='toml-validate.js')}}"></script>
    {% endblock %}